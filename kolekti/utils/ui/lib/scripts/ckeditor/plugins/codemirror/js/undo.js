function UndoHistory(b,c,d,e){var g=this;g.container=b;g.maxDepth=c;g.commitDelay=d;g.editor=e;var f={text:'',from:null,to:null};g.first=f;g.last=f;g.firstTouched=false;g.history=[];g.redoHistory=[];g.touched=[];g.lostundo=0;};UndoHistory.prototype={scheduleCommit:function(){var b=this;parent.clearTimeout(this.commitTimeout);this.commitTimeout=parent.setTimeout(function(){b.tryCommit();},this.commitDelay);},touch:function(b){this.setTouched(b);this.scheduleCommit();},undo:function(){var c=this;c.commit();if(c.history.length){var b=c.history.pop();c.redoHistory.push(c.updateTo(b,'applyChain'));c.notifyEnvironment();return c.chainNode(b);}},redo:function(){var c=this;c.commit();if(c.redoHistory.length){var b=c.redoHistory.pop();c.addUndoLevel(c.updateTo(b,'applyChain'));c.notifyEnvironment();return c.chainNode(b);}},clear:function(){this.history=[];this.redoHistory=[];this.lostundo=0;},historySize:function(){return{undo:this.history.length,redo:this.redoHistory.length,lostundo:this.lostundo};},push:function(b,c,d){var e=[];for(var f=0;f<d.length;f++){var g=f==d.length-1?c:document.createElement('br');e.push({from:b,to:g,text:cleanText(d[f])});b=g;}this.pushChains([e],b==null&&c==null);this.notifyEnvironment();},pushChains:function(b,c){var d=this;d.commit(c);d.addUndoLevel(d.updateTo(b,'applyChain'));d.redoHistory=[];},chainNode:function(b){for(var c=0;c<b.length;c++){var d=b[c][0],e=d&&(d.from||d.to);if(e)return e;}},reset:function(){this.history=[];this.redoHistory=[];this.lostundo=0;},textAfter:function(b){return this.after(b).text;},nodeAfter:function(b){return this.after(b).to;},nodeBefore:function(b){return this.before(b).from;},tryCommit:function(){if(!window||!window.parent||!window.UndoHistory)return;if(this.editor.highlightDirty())this.commit(true);else this.scheduleCommit();},commit:function(b){var e=this;parent.clearTimeout(e.commitTimeout);if(!b)e.editor.highlightDirty(true);var c=e.touchedChains(),d=e;if(c.length){e.addUndoLevel(e.updateTo(c,'linkChain'));e.redoHistory=[];e.notifyEnvironment();}},updateTo:function(b,c){var d=[],e=[];for(var f=0;f<b.length;f++){d.push(this.shadowChain(b[f]));e.push(this[c](b[f]));}if(c=='applyChain')this.notifyDirty(e);return d;},notifyDirty:function(b){forEach(b,method(this.editor,'addDirtyNode'));this.editor.scheduleHighlight();},notifyEnvironment:function(){if(this.onChange)this.onChange(this.editor);if(window.frameElement&&window.frameElement.CodeMirror.updateNumbers)window.frameElement.CodeMirror.updateNumbers();
},linkChain:function(b){for(var c=0;c<b.length;c++){var d=b[c];if(d.from)d.from.historyAfter=d;else this.first=d;if(d.to)d.to.historyBefore=d;else this.last=d;}},after:function(b){return b?b.historyAfter:this.first;},before:function(b){return b?b.historyBefore:this.last;},setTouched:function(b){if(b){if(!b.historyTouched){this.touched.push(b);b.historyTouched=true;}}else this.firstTouched=true;},addUndoLevel:function(b){var c=this;c.history.push(b);if(c.history.length>c.maxDepth){c.history.shift();c.lostundo+=1;}},touchedChains:function(){var b=this,c=null;function d(j){return j?j.historyTemp:c;};function e(j,k){if(j)j.historyTemp=k;else c=k;};function f(j){var k=[];for(var l=j?j.nextSibling:b.container.firstChild;l&&(!isBR(l)||l.hackBR);l=l.nextSibling){if(!l.hackBR&&l.currentText)k.push(l.currentText);}return{from:j,to:l,text:cleanText(k.join(''))};};var g=[];if(b.firstTouched)b.touched.push(null);forEach(b.touched,function(j){if(j&&(j.parentNode!=b.container||j.hackBR))return;if(j)j.historyTouched=false;else b.firstTouched=false;var k=f(j),l=b.after(j);if(!l||l.text!=k.text||l.to!=k.to){g.push(k);e(j,k);}});function h(j,k){var l=k+'Sibling',m=j[l];while(m&&!isBR(m))m=m[l];return m;};var i=[];b.touched=[];forEach(g,function(j){if(!d(j.from))return;var k=[],l=j.from,m=true;for(;;){var n=d(l);if(!n)if(m)break;else n=f(l);k.unshift(n);e(l,null);if(!l)break;m=b.after(l);l=h(l,'previous');}l=j.to;m=b.before(j.from);for(;;){if(!l)break;var n=d(l);if(!n)if(m)break;else n=f(l);k.push(n);e(l,null);m=b.before(l);l=h(l,'next');}i.push(k);});return i;},shadowChain:function(b){var c=[],d=this.after(b[0].from),e=b[b.length-1].to;for(;;){c.push(d);var f=d.to;if(!f||f==e)break;else d=f.historyAfter||this.before(e);}return c;},applyChain:function(b){var c=select.cursorPos(this.container,false),d=this;function e(n,o){var p=n?n.nextSibling:d.container.firstChild;while(p!=o){var q=p.nextSibling;removeElement(p);p=q;}};var f=b[0].from,g=b[b.length-1].to;e(f,g);for(var h=0;h<b.length;h++){var i=b[h];if(h>0)d.container.insertBefore(i.from,g);var j=makePartSpan(fixSpaces(i.text));d.container.insertBefore(j,g);if(c&&c.node==i.from){var k=0,l=this.after(i.from);if(l&&h==b.length-1){for(var m=0;m<c.offset&&i.text.charAt(m)==l.text.charAt(m);m++){}if(c.offset>m)k=i.text.length-l.text.length;}select.setCursorPos(this.container,{node:i.from,offset:Math.max(0,c.offset+k)});}else if(c&&h==b.length-1&&c.node&&c.node.parentNode!=this.container)select.setCursorPos(this.container,{node:i.from,offset:i.text.length});
}this.linkChain(b);return f;}};
