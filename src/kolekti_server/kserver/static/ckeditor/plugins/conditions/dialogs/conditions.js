(function(){var g=function(e,h){var f={},g=function(e){console.log(f);critexps=e.split(";");$.each(critexps,function(c,a){var b="=\\",b=a.match(/= *\\?/)[0];critvals=a.split(b);var d=critvals[0].trim();console.log(critvals[0]);f[d].operator=b.replace(" ","");f[d].values=[];$.each(critvals[1].split(","),function(b,a){f[d].values.push(a.trim())})});return critexps};return{title:e.lang.conditions["insert"==h?"titleInsert":"titleModify"],minWidth:400,minHeight:200,contents:[{id:"tab-basic",label:"Critères",
elements:function(){var i=[];console.log("condition menu");var c=function(a){var b="",d=!0;$.each(f,function(a,c){c.values.length&&(d||(b+=" ; "),d=!1,b+=c.code,b+=" ",b+=c.operator,b+=" ",console.log("ser -> "+c.code+c.operator),$.each(c.values,function(a,c){0<a&&(b+=" , ");b+=c}))});console.log("update expr");console.log(f);console.log(b);a.getContentElement("tab-basic","cond_ID").setValue(b,!1)};$.ajax({type:"GET",url:"/criteria.json",contentType:"application/json; charset=utf-8",dataType:"json",
async:!1,success:function(a){$.each(a,function(b,a){f[b]={code:b,def:a,operator:"=",values:[]};var e=[];$.each(a,function(a,b){console.log(b);e.push([b,b])});i.push({type:"hbox",widths:["280px","110px"],align:"left",children:[{type:"html",html:'<span class="condition_dialoglabel">'+b+"</span>"},{type:"select",id:"operator_ID_"+b,items:[[" = ","="],["= \\ ","= \\"]],"default":"=",onChange:function(){var a=this.getValue();console.log("set operator "+b+a);f[b].operator=a;c(this.getDialog())}},{type:"select",
id:"crit_ID_"+b,items:e,onClick:function(){var a=this.getValue();-1==f[b].values.indexOf(a)&&f[b].values.push(a);c(this.getDialog())}},{type:"button",id:"del_ID_"+b,label:"X",onClick:function(){f[b].values=[];f[b].operator="=";c(this.getDialog())}}]})})},error:function(a,b,c){alert(a.status);alert(c)}});i.push({type:"hbox",widths:["280px","110px"],align:"left",children:[{type:"text",id:"cond_ID",label:"Expression condition :",validate:function(){console.log("validate")},setup:function(){console.log("setup")},
onChange:function(){console.log("onChange "+h);g(this.getValue())},onShow:function(){console.log("onShow "+h);"edit"==h&&(console.log(e.conditions_getSelected()),this.setValue(e.conditions_getSelected().getAttribute("class"),!1),g(this.getValue()))}}]});"insert"==h&&i.push({type:"hbox",widths:["280px","110px"],align:"left",children:[{type:"checkbox",id:"force_create",label:"Forcer la création d'un élément div ou span"}]});return i}()}],onShow:function(){$.each(f,function(e,c){c.values=[];c.operator=
"="})},onOk:function(){var f=this.getValueOf("tab-basic","cond_ID"),c=null;if("edit"==h)c=e.conditions_getSelected();else if(selection=e.getSelection(),selection.getType()==CKEDITOR.SELECTION_ELEMENT){var a=selection.getSelectedElement();if(this.getValueOf("tab-basic","force_create")||a.hasAttribute("class"))c=a.hasAscendent("p",!1)?e.document.createElement("span"):e.document.createElement("div"),c.insertAfter(a),a.move(c,!0)}else if(selection.getType()==CKEDITOR.SELECTION_TEXT){var c=selection.getCommonAncestor(),
b=selection.getRanges()[0],a=b.startContainer,d=b.endContainer;c.type==CKEDITOR.NODE_TEXT&&(a.split(b.endOffset),d=a=a.split(b.startOffset),c=c.getParent());if(!a.equals(c))for(;a&&!a.getParent().equals(c);){a.type==CKEDITOR.NODE_TEXT&&1<b.startOffset&&(a=a.split(b.startOffset));if(a.hasPrevious()){var g=a.getParent().clone();for(g.insertBefore(a.getParent());a.hasPrevious();)a.getPrevious().move(g)}a=a.getParent()}if(!d.equals(c))for(;d&&!d.getParent().equals(c);){d.type==CKEDITOR.NODE_TEXT&&1<b.endOffset&&
d.split(b.endOffset);if(d.hasNext()){g=d.getParent().clone();for(g.insertAfter(d.getParent());d.hasNext();)d.getNext().move(g)}d=d.getParent()}if(this.getValueOf("tab-basic","force_create")||a.hasPrevious()||d.hasNext()||c.hasAttribute("class")){c=a.type==CKEDITOR.NODE_TEXT||a.hasAscendent("p",!1)?e.document.createElement("span"):e.document.createElement("div");c.insertBefore(a);for(moved=a;moved&&!moved.equals(d);)a=moved.getNext(),moved.move(c),moved=a;d.move(c)}}c.setAttribute("class",f)}}};CKEDITOR.dialog.add("editCondition",
function(e){return g(e,"edit")});CKEDITOR.dialog.add("insertCondition",function(e){return g(e,"insert")})})();