(function(){var g=function(e,h){var f={},g=function(e){critexps=e.split(";");$.each(critexps,function(b,a){if(0!=a.length){var d="=\\",d=a.match(/= *\\?/)[0];critvals=a.split(d);var c=critvals[0].trim();f[c].operator=d.replace(" ","");f[c].values=[];$.each(critvals[1].split(","),function(a,d){f[c].values.push(d.trim())})}});return critexps};return{title:e.lang.conditions["insert"==h?"titleInsert":"titleModify"],minWidth:400,minHeight:200,contents:[{id:"tab-basic",label:"Critères",elements:function(){var i=
[],b=function(a){var d="",c=!0;$.each(f,function(a,b){b.values.length&&(c||(d+=" ; "),c=!1,d+=b.code,d+=" ",d+=b.operator,d+=" ",$.each(b.values,function(a,b){0<a&&(d+=" , ");d+=b}))});a.getContentElement("tab-basic","cond_ID").setValue(d,!1)};$.ajax({type:"GET",url:"/criteria.json",contentType:"application/json; charset=utf-8",dataType:"json",async:!1,success:function(a){$.each(a,function(a,c){f[a]={code:a,def:c,operator:"=",values:[]};var e=[];e.push(["-- select --",""]);$.each(c,function(a,b){e.push([b,
b])});i.push({type:"hbox",widths:["280px","110px"],align:"left",children:[{type:"html",html:'<span class="condition_dialoglabel">'+a+"</span>"},{type:"select",id:"operator_ID_"+a,items:[[" = ","="],["= \\ ","= \\"]],"default":"=",onChange:function(){var c=this.getValue();f[a].operator=c;b(this.getDialog())}},{type:"select",id:"crit_ID_"+a,items:e,onClick:function(){var c=this.getValue();c.length&&-1==f[a].values.indexOf(c)&&f[a].values.push(c);b(this.getDialog());this.setValue("")}},{type:"button",
id:"del_ID_"+a,label:"X",onClick:function(){f[a].values=[];f[a].operator="=";b(this.getDialog())}}]})})},error:function(a,b,c){alert(a.status);alert(c)}});i.push({type:"hbox",widths:["280px","110px"],align:"left",children:[{type:"text",id:"cond_ID",label:"Expression condition :",validate:function(){console.log("validate")},setup:function(){console.log("setup")},onChange:function(){console.log("onChange "+h);g(this.getValue())},onShow:function(){console.log("onShow "+h);"edit"==h&&(this.setValue(e.conditions_getSelected().getAttribute("class"),
!1),g(this.getValue()))}}]});"insert"==h&&i.push({type:"hbox",widths:["280px","110px"],align:"left",children:[{type:"checkbox",id:"force_create",label:"Forcer la création d'un élément div ou span"}]});return i}()}],onShow:function(){$.each(f,function(e,b){b.values=[];b.operator="="})},onOk:function(){var f=this.getValueOf("tab-basic","cond_ID"),b=null;if("edit"==h)b=e.conditions_getSelected();else if(selection=e.getSelection(),selection.getType()==CKEDITOR.SELECTION_ELEMENT){var a=selection.getSelectedElement();
if(this.getValueOf("tab-basic","force_create")||a.hasAttribute("class"))b=a.hasAscendant("p",!1)?e.document.createElement("span"):e.document.createElement("div"),b.insertAfter(a),a.move(b,!0)}else if(selection.getType()==CKEDITOR.SELECTION_TEXT){var b=selection.getCommonAncestor(),d=selection.getRanges()[0],a=d.startContainer,c=d.endContainer;b.type==CKEDITOR.NODE_TEXT&&(a.split(d.endOffset),c=a=a.split(d.startOffset),b=b.getParent());if(a.equals(b)||c.equals(b))a=c=b;if(!a.equals(b))for(;a&&!a.getParent().equals(b);){a.type==
CKEDITOR.NODE_TEXT&&1<d.startOffset&&(a=a.split(d.startOffset));if(a.hasPrevious()){var g=a.getParent().clone();for(g.insertBefore(a.getParent());a.hasPrevious();)a.getPrevious().move(g)}a=a.getParent()}if(!c.equals(b))for(;c&&!c.getParent().equals(b);){c.type==CKEDITOR.NODE_TEXT&&1<d.endOffset&&c.split(d.endOffset);if(c.hasNext()){g=c.getParent().clone();for(g.insertAfter(c.getParent());c.hasNext();)c.getNext().move(g)}c=c.getParent()}if(this.getValueOf("tab-basic","force_create")||a.type==CKEDITOR.NODE_TEXT&&
a.hasPrevious()||c.type==CKEDITOR.NODE_TEXT&&c.hasNext()||b.hasAttribute("class")){b=a.type==CKEDITOR.NODE_TEXT||a.hasAscendant("p",!1)?e.document.createElement("span"):e.document.createElement("div");b.insertBefore(a);for(moved=a;moved&&!moved.equals(c);)a=moved.getNext(),moved.move(b),moved=a;c.move(b)}}b.setAttribute("class",f)}}};CKEDITOR.dialog.add("editCondition",function(e){return g(e,"edit")});CKEDITOR.dialog.add("insertCondition",function(e){return g(e,"insert")})})();